<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spazi - CoWorkSpace</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/variables.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
<!-- Navigation -->
<div id="navbar-container">
    <!-- Navigation - Header diretto senza component -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-building"></i> CoWorkSpace
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="spaces.html">Spazi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">Chi Siamo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="support.html">Supporto</a>
                    </li>
                </ul>

                <div class="navbar-nav">
                    <div id="authButtons">
                        <button class="btn btn-outline-primary me-2" onclick="showLogin()">
                            <i class="fas fa-sign-in-alt"></i> Accedi
                        </button>
                        <button class="btn btn-primary" onclick="showRegister()">
                            <i class="fas fa-user-plus"></i> Registrati
                        </button>
                    </div>
                    <div id="userMenu" style="display: none;">
                        <div class="dropdown">
                            <button class="btn btn-link dropdown-toggle p-0" type="button" data-bs-toggle="dropdown">
                                <div class="user-avatar">
                                    <span id="userInitial"></span>
                                </div>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><div class="dropdown-header">
                                    <span id="userFullName"></span><br>
                                    <small class="text-muted" id="userEmail"></small>
                                </div></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
                                    <i class="fas fa-user-circle"></i> Profilo
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="showSection('bookings')">
                                    <i class="fas fa-calendar-check"></i> Le Mie Prenotazioni
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li id="managerMenuItem" style="display: none;">
                                    <a class="dropdown-item" href="manager-dashboard.html">
                                        <i class="fas fa-user-tie me-2"></i> Pannello Manager
                                    </a>
                                </li>
                                <li id="adminMenuItem" style="display: none;">
                                    <a class="dropdown-item" href="admin-dashboard.html">
                                        <i class="fas fa-cog me-2"></i> Pannello Admin
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</div>

<!-- Spaces Section -->
<section class="section-padding" style="margin-top: 10px;">
    <div class="container">
        <!-- Results Header with View Toggle -->
        <div class="results-header">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="mb-2 mb-md-0">
                    <h2><i class="fas fa-building text-primary"></i> Spazi Disponibili</h2>
                    <p class="results-count" id="resultsCount">Caricamento spazi...</p>
                </div>
            </div>
        </div>

        <!-- Spaces Grid -->
        <div id="spacesContainer" class="spaces-grid">
            <script>
                // Inizializza la pagina spazi
                document.addEventListener('DOMContentLoaded', function() {
                    // Inizializza auth manager per mantenere stato login
                    if (window.auth) {
                        window.auth.init();
                    }

                    // Carica componenti comuni (escludi navbar che Ã¨ ora diretta)
                    loadComponent('footer-container', 'components/footer.html');
                    loadComponent('modals-container', 'components/modals.html');

                    // Carica gli spazi
                    loadSpaces();

                    // Recupera parametri di ricerca se presenti
                    const searchParams = localStorage.getItem('searchParams');
                    if (searchParams) {
                        const params = JSON.parse(searchParams);
                        if (params.city) document.getElementById('quickCity').value = params.city;
                        if (params.type) document.getElementById('quickSpaceType').value = params.type;
                        localStorage.removeItem('searchParams');
                    }
                });
            </script>
        </div>
    </div>
</section>

<!-- Footer -->
<div id="footer-container"></div>

<!-- Modals -->
<div id="modals-container">
    <!-- Modal Login -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-sign-in-alt me-2"></i>Accedi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" name="password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe" name="rememberMe">
                            <label class="form-check-label" for="rememberMe">Ricordami</label>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>Accedi
                            </button>
                        </div>
                    </form>
                    <div class="text-center mt-3">
                        <p class="mb-0">Non hai un account?
                            <a href="#" onclick="switchToRegister()">Registrati qui</a>
                        </p>
                        <a href="#" class="text-muted small" onclick="alert('Funzione di recupero password in arrivo!')">
                            Hai dimenticato la password?
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Register -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Registrati
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" name="registerEmail" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="registerName" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="registerName" name="registerName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="registerSurname" class="form-label">Cognome</label>
                                <input type="text" class="form-control" id="registerSurname" name="registerSurname" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" name="registerPassword" required>
                            <div class="form-text">Minimo 8 caratteri con una maiuscola, una minuscola e un numero</div>
                        </div>
                        <div class="mb-3">
                            <label for="registerPasswordConfirm" class="form-label">Conferma Password</label>
                            <input type="password" class="form-control" id="registerPasswordConfirm" name="registerPasswordConfirm" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPhone" class="form-label">Telefono (opzionale)</label>
                            <input type="tel" class="form-control" id="registerPhone" name="registerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="registerCompany" class="form-label">Azienda (opzionale)</label>
                            <input type="text" class="form-control" id="registerCompany" name="registerCompany">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="acceptTerms" name="acceptTerms" required>
                            <label class="form-check-label" for="acceptTerms">
                                Accetto i <a href="#" onclick="alert('Termini e condizioni in arrivo!')">Termini e Condizioni</a>
                                e l'<a href="#" onclick="alert('Informativa Privacy in arrivo!')">Informativa Privacy</a>
                            </label>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="acceptMarketing" name="acceptMarketing">
                            <label class="form-check-label" for="acceptMarketing">
                                Accetto di ricevere comunicazioni marketing (facoltativo)
                            </label>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-user-plus me-2"></i>Registrati
                            </button>
                        </div>
                    </form>
                    <div class="text-center mt-3">
                        <p class="mb-0">Hai giÃ  un account?
                            <a href="#" onclick="switchToLogin()">Accedi qui</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="notification-container"></div>

<!-- Back to Top Button -->
<button id="backToTop" class="back-to-top" style="display: none;" onclick="scrollToTop()">
    <i class="fas fa-chevron-up"></i>
</button>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

<!-- App Scripts -->
<script src="https://js.stripe.com/v3/"></script>

<script src="../assets/js/config.js"></script>
<script src="../assets/js/utils.js"></script>
<script src="../assets/js/components.js"></script>
<script src="../assets/js/notification.js"></script>
<script src="../assets/js/navigation.js"></script>
<script src="../assets/js/booking.js"></script>
<script src="../assets/js/app.js"></script>

<script>

    document.addEventListener('DOMContentLoaded', () => {
        // Attendiamo che window.auth sia disponibile
        if (window.auth && window.BookingManager) {
            // Se l'utente Ã¨ loggato, inizializziamo il gestore di prenotazioni
            if (window.auth.isAuthenticated()) {
                console.log('â Utente autenticato. Inizializzazione gestore prenotazioni.');
                window.BookingManager.init();

                // Aggiorniamo la UI (es. pulsante di login/logout)
                window.auth.updateUI();
            } else {
                console.log('â Utente non autenticato. Mostriamo solo gli spazi.');
            }
        } else {
            console.error('Errore: AuthManager o BookingManager non sono disponibili.');
        }
    });

    function logout() {
        if (window.auth) {
            window.auth.handleLogout();
        }
    }

    // Implementazione funzioni mancanti
    window.loadComponent = async function(containerId, componentPath) {
        const container = document.getElementById(containerId);
        if (!container) return;

        try {
            const response = await fetch(componentPath);
            if (response.ok) {
                container.innerHTML = await response.text();
            }
        } catch (error) {
            console.log('Component load skipped:', componentPath);
        }
    };

    window.loadSpaces = async function(filteredSpaces = null) {
        const container = document.getElementById('spacesContainer');
        if (!container) return;

        try {
            // Mostra loading
            container.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3">Caricamento spazi...</p>
            </div>
        `;

            let spaces;
            if (filteredSpaces) {
                spaces = filteredSpaces;
            } else {
                // Chiama API
                const response = await fetch('http://localhost:3000/api/spaces');
                const data = await response.json();
                spaces = data.success ? (data.data || data.spaces || []) : [];
            }

            // Renderizza spazi
            if (spaces.length === 0) {
                container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <h4>Nessuno spazio trovato</h4>
                    <p class="text-muted">Riprova piÃ¹ tardi</p>
                </div>
            `;
            } else {
                const spacesHTML = spaces.map(space => {
                    // Calcola rating stelle
                    const rating = parseFloat(space.avg_rating) || 0;
                    const fullStars = Math.floor(rating);
                    const halfStar = rating % 1 >= 0.5;
                    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

                    let starsHTML = '';
                    for (let i = 0; i < fullStars; i++) {
                        starsHTML += '<i class="fas fa-star text-warning"></i>';
                    }
                    if (halfStar) {
                        starsHTML += '<i class="fas fa-star-half-alt text-warning"></i>';
                    }
                    for (let i = 0; i < emptyStars; i++) {
                        starsHTML += '<i class="far fa-star text-warning"></i>';
                    }

                    // Badge tipo spazio
                    const typeBadges = {
                        'hot-desk': { label: 'Hot Desk', class: 'bg-primary' },
                        'private-office': { label: 'Ufficio Privato', class: 'bg-success' },
                        'meeting-room': { label: 'Sala Riunioni', class: 'bg-info' },
                        'event-space': { label: 'Spazio Eventi', class: 'bg-warning' }
                    };

                    const typeBadge = typeBadges[space.type] || { label: space.type, class: 'bg-secondary' };

                    // Icone servizi
                    const amenityIcons = {
                        'wifi': 'fas fa-wifi',
                        'coffee': 'fas fa-coffee',
                        'printer': 'fas fa-print',
                        'parking': 'fas fa-parking'
                    };

                    const amenitiesHTML = (space.amenities || []).slice(0, 4).map(amenity =>
                        `<i class="${amenityIcons[amenity] || 'fas fa-check'} text-success me-1" title="${amenity}"></i>`
                    ).join('');

                    const extraAmenities = (space.amenities || []).length > 4 ? `+${(space.amenities || []).length - 4}` : '';

                    return `
            <div class="space-card-modern">
                <div class="space-image-container" style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <img src="${space.images?.[0] || '/assets/images/placeholder-space.jpg'}"
                        class="space-image" alt="${space.name}">

                    <div class="space-badge" style="margin-left: auto;">
                        <span class="badge ${typeBadge.class}">${typeBadge.label}</span>
                    </div>
                </div>

                <div class="space-content">
                    <h5 class="space-title">${space.name}</h5>
                    <p class="space-location">
                        <i class="fas fa-map-marker-alt text-primary me-1"></i>
                            ${space.city}
                    </p>

                    <p class="space-description">
                        ${space.description ? space.description.substring(0, 120) + '...' : 'Spazio di coworking moderno e funzionale.'}
                    </p>

                    <div class="space-amenities">
                        ${amenitiesHTML}
                        ${extraAmenities ? `<span class="text-muted">${extraAmenities}</span>` : ''}
                    </div>

                    <div class="space-info">
                        <div class="space-capacity">
                            <i class="fas fa-users text-primary me-1"></i>
                            <span>${space.capacity} persone</span>
                        </div>
                        <div class="space-price">
                            <span class="price-amount">â¬${space.price_per_day}</span>
                            <span class="price-period">/giorno</span>
                        </div>
                    </div>
                </div>

                <div class="space-actions">
                    <button class="btn btn-outline-primary btn-details" onclick="viewSpaceDetails('${space.id}')">
                        Dettagli
                    </button>
                    <button class="btn btn-primary btn-book" onclick="bookSpace('${space.id}')">
                        Prenota
                    </button>
                </div>
            </div>
    `;
                }).join('');

                container.innerHTML = spacesHTML;
            }

            // Aggiorna contatore
            const resultsCount = document.getElementById('resultsCount');
            if (resultsCount) {
                resultsCount.textContent = `${spaces.length} spazi disponibili`;
            }

        } catch (error) {
            console.error('Error loading spaces:', error);
            container.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="alert alert-danger">
                    <h5>Errore di caricamento</h5>
                    <p>Impossibile caricare gli spazi. Verifica che il server sia attivo.</p>
                    <button class="btn btn-primary" onclick="loadSpaces()">Riprova</button>
                </div>
            </div>
        `;
        }
    };

    // Inizializzazione
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('ð¢ Initializing spaces page...');

        // Carica componenti
        await loadComponent('navbar-container', 'components/navbar.html');
        await loadComponent('footer-container', 'components/footer.html');
        await loadComponent('modals-container', 'components/modals.html');

        // Carica spazi
        await loadSpaces();

        // Gestisci parametri ricerca
        const searchParams = localStorage.getItem('searchParams');
        if (searchParams) {
            try {
                const params = JSON.parse(searchParams);
                console.log('ð Applying search params:', params);

                // Se esiste il sistema di filtri, usalo
                if (window.SearchFilters) {
                    window.SearchFilters.initSpacesPage();
                }

                localStorage.removeItem('searchParams');
            } catch (error) {
                console.error('Error parsing search params:', error);
            }
        }

        console.log('â Spaces page ready');
    });

    window.viewSpaceDetails = function(spaceId) {
        console.log('ðï¸ Viewing details for space:', spaceId);
        if (window.showNotification) {
            window.showNotification('Dettagli spazio in arrivo...', 'info');
        }
        // Qui implementerai il modal dei dettagli
    };

    // Override della funzione bookSpace esistente
    window.bookSpace = function(spaceId) {
        console.log('ð Booking space:', spaceId);

        // Verifica autenticazione
        const token = localStorage.getItem('auth_token');
        if (!token) {
            console.log('â No auth token found');

            if (window.showNotification) {
                window.showNotification('Devi effettuare il login per prenotare', 'warning');
            } else {
                alert('Devi effettuare il login per prenotare');
            }

            // Mostra modal login se disponibile
            if (window.showLogin) {
                setTimeout(() => window.showLogin(), 1000);
            }
            return;
        }

        console.log('â Auth token found, opening booking modal...');

        // Usa il BookingManager se disponibile
        if (window.BookingManager && window.BookingManager.openBookingModal) {
            window.BookingManager.openBookingModal(spaceId);
        } else {
            console.error('â BookingManager not found!');

            if (window.showNotification) {
                window.showNotification('Sistema di prenotazione in caricamento...', 'info');
            }

            // Retry dopo un secondo
            setTimeout(() => {
                if (window.BookingManager) {
                    window.BookingManager.openBookingModal(spaceId);
                } else {
                    alert('Sistema di prenotazione non disponibile. Ricarica la pagina.');
                }
            }, 1000);
        }
    };

    // Debug function
    window.debugBookingFlow = function() {
        console.log('ð Debugging booking flow...');
        console.log('- Auth token:', localStorage.getItem('auth_token') ? 'Present' : 'Missing');
        console.log('- BookingManager:', typeof window.BookingManager);
        console.log('- BookingManager.openBookingModal:', typeof window.BookingManager?.openBookingModal);
        console.log('- showNotification:', typeof window.showNotification);
        console.log('- Bootstrap Modal:', typeof bootstrap?.Modal);

        return {
            hasAuth: !!localStorage.getItem('auth_token'),
            hasBookingManager: typeof window.BookingManager === 'object',
            hasOpenModal: typeof window.BookingManager?.openBookingModal === 'function',
            hasNotification: typeof window.showNotification === 'function',
            hasBootstrap: typeof bootstrap?.Modal === 'function'
        };
    };
</script>
</body>
</html>