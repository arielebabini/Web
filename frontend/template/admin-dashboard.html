<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Admin Dashboard - CoWorkSpace</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js (solo JS, niente CSS!) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-solid: #667eea;
            --sidebar-width: 280px;
            --header-height: 70px;
        }

        body {
            background: #f8fafc;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Sidebar */
        .admin-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
            color: white;
            z-index: 1000;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .admin-sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #4a5568;
            text-align: center;
        }

        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            text-decoration: none;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .sidebar-item {
            margin: 0.25rem 1rem;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #e2e8f0;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .sidebar-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(4px);
        }

        .sidebar-link.active {
            background: var(--primary);
            color: white;
        }

        .sidebar-icon {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }

        /* Main content */
        .admin-main {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .admin-main.expanded {
            margin-left: 80px;
        }

        .admin-header {
            background: white;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .admin-content {
            padding: 2rem;
        }

        /* Cards */
        .admin-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12);
        }

        .stats-card {
            background: var(--primary);
            color: white;
            border: none;
        }

        .stats-card .stats-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        /* Tables */
        .admin-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
        }

        .admin-table table {
            margin: 0;
        }

        .admin-table th {
            background: #f8fafc;
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #4a5568;
        }

        .admin-table td {
            border: none;
            padding: 1rem 1.5rem;
            vertical-align: middle;
        }

        .admin-table tbody tr {
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s ease;
        }

        .admin-table tbody tr:hover {
            background: #f7fafc;
        }

        /* Buttons */
        .btn-admin {
            border-radius: 8px;
            font-weight: 600;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .btn-admin-primary {
            background: var(--primary);
            border: none;
            color: white;
        }

        .btn-admin-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }

        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-suspended {
            background: #fff3cd;
            color: #856404;
        }

        /* Role badges */
        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .role-admin {
            background: #e1effe;
            color: #1e40af;
        }

        .role-manager {
            background: #f0fdf4;
            color: #166534;
        }

        .role-client {
            background: #fef3c7;
            color: #92400e;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-sidebar {
                transform: translateX(-100%);
            }

            .admin-sidebar.mobile-open {
                transform: translateX(0);
            }

            .admin-main {
                margin-left: 0;
            }
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
</head>
<body>
<!-- Sidebar -->
<div class="admin-sidebar" id="adminSidebar">
    <div class="sidebar-header">
        <a class="sidebar-brand" href="#">
            <i class="fas fa-cog"></i>
            <span class="brand-text">Admin</span>
        </a>
        <button class="btn btn-link text-white d-md-none" onclick="toggleSidebar()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="sidebar-menu">
        <div class="sidebar-item">
            <a class="sidebar-link active" href="#dashboard" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt sidebar-icon"></i>
                <span>Dashboard</span>
            </a>
        </div>
        <div class="sidebar-item">
            <a class="sidebar-link" href="#users" onclick="showSection('users')">
                <i class="fas fa-users sidebar-icon"></i>
                <span>Gestione Utenti</span>
            </a>
        </div>
        <div class="sidebar-item">
            <a class="sidebar-link" href="#spaces" onclick="showSection('spaces')">
                <i class="fas fa-building sidebar-icon"></i>
                <span>Gestione Spazi</span>
            </a>
        </div>
        <div class="sidebar-item">
            <a class="sidebar-link" href="#bookings" onclick="showSection('bookings')">
                <i class="fas fa-calendar-check sidebar-icon"></i>
                <span>Prenotazioni</span>
            </a>
        </div>
        <div class="sidebar-item mt-4">
            <a class="sidebar-link" href="../index.html">
                <i class="fas fa-arrow-left sidebar-icon"></i>
                <span>Torna al Sito</span>
            </a>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="admin-main" id="adminMain">
    <!-- Header -->
    <div class="admin-header">
        <div class="d-flex align-items-center">
            <button class="btn btn-link d-md-none me-3" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <h4 class="mb-0" id="pageTitle">Dashboard</h4>
        </div>
        <div class="d-flex align-items-center">
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-user"></i>
                    <span id="adminUserName">Admin</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#profile"><i class="fas fa-user me-2"></i>Profilo</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="admin-content">
        <!-- Dashboard Section -->
        <div class="admin-section" id="dashboardSection">
            <!-- Loading Overlay -->
            <div class="position-fixed..." id="dashboard-loading" style="display: none !important;">
                <div class="text-center">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                    <div class="mt-2">Caricamento statistiche...</div>
                </div>
            </div>

            <!-- Error Container -->
            <div id="dashboard-error" style="display: none;"></div>

            <!-- Header Dashboard -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4><i class="fas fa-chart-line text-primary"></i> Dashboard Amministratore</h4>
                </div>
            </div>

            <!-- Statistiche Generali -->
            <div class="row mb-4">
                <!-- Utenti -->
                <div class="col-md-3 mb-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Utenti Totali</h6>
                                    <h3 class="mb-0" id="total-users">0</h3>
                                    <small>+<span id="new-users">0</span> nuovi</small>
                                </div>
                                <i class="fas fa-users fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Spazi -->
                <div class="col-md-3 mb-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Spazi Attivi</h6>
                                    <h3 class="mb-0" id="total-spaces">0</h3>
                                    <small>spazi disponibili</small>
                                </div>
                                <i class="fas fa-building fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prenotazioni -->
                <div class="col-md-3 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Prenotazioni</h6>
                                    <h3 class="mb-0" id="total-bookings">0</h3>
                                    <small><span id="confirmed-bookings">0</span> confermate</small>
                                </div>
                                <i class="fas fa-calendar-check fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Revenue -->
                <div class="col-md-3 mb-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Revenue Totale</h6>
                                    <h3 class="mb-0" id="total-revenue">€0.00</h3>
                                    <small><span id="total-payments">0</span> pagamenti</small>
                                </div>
                                <i class="fas fa-euro-sign fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Riga con Grafici e Statistiche -->
            <div class="row">
                <!-- Grafico Revenue -->
                <div class="col-md-8 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-area text-success"></i> Andamento Revenue</h5>
                        </div>
                        <div class="card-body">
                            <!-- Statistiche Revenue -->
                            <div class="row mb-3">
                                <div class="col-md-4 text-center">
                                    <div class="border-end">
                                        <h6 class="text-muted">Periodo Corrente</h6>
                                        <h4 class="text-success" id="current-revenue">€0.00</h4>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="border-end">
                                        <h6 class="text-muted">Periodo Precedente</h6>
                                        <h4 class="text-muted" id="previous-revenue">€0.00</h4>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <h6 class="text-muted">Crescita</h6>
                                    <h4 id="revenue-growth">+0.0%</h4>
                                </div>
                            </div>

                            <!-- Area Grafico -->
                          <div id="revenue-chart" class="mt-3">
                            <canvas id="revenueChartCanvas" width="400" height="200"></canvas>
                          </div>
                        </div>
                    </div>
                </div>

                <!-- Top Spazi -->
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-trophy text-warning"></i> Top Spazi</h5>
                        </div>
                        <div class="card-body">
                            <div id="top-spaces-list">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-building fa-2x mb-2"></i>
                                    <p>Caricamento top spazi...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiche Aggiuntive -->
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-credit-card fa-2x text-primary mb-2"></i>
                            <h6 class="text-muted">Pagamenti Medi</h6>
                            <h4 id="average-transaction">€0.00</h4>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-percentage fa-2x text-success mb-2"></i>
                            <h6 class="text-muted">Tasso Conversione</h6>
                            <h4 id="conversion-rate-detail">0%</h4>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-clock fa-2x text-info mb-2"></i>
                            <h6 class="text-muted">Ultimo Aggiornamento</h6>
                            <small id="last-update">Ora</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Management Section -->
        <div class="admin-section" id="usersSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>
                    <i class="fas fa-users text-primary me-2"></i>
                    Gestione Utenti
                </h4>
                <button class="btn btn-admin-primary" onclick="showAddUserModal()">
                    <i class="fas fa-plus me-2"></i>Nuovo Utente
                </button>
            </div>

            <!-- Filters -->
            <div class="admin-card mb-4">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Cerca</label>
                        <input class="form-control" id="userSearch" placeholder="Nome, email..." type="text">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Ruolo</label>
                        <select class="form-select" id="roleFilter">
                            <option value="">Tutti</option>
                            <option value="client">Client</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Tutti</option>
                            <option value="active">Attivo</option>
                            <option value="inactive">Inattivo</option>
                            <option value="suspended">Sospeso</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="applyUserFilters()">
                                <i class="fas fa-search"></i> Filtra
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetUserFilters()">
                                <i class="fas fa-refresh"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="admin-table">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>Utente</th>
                        <th>Email</th>
                        <th>Ruolo</th>
                        <th>Status</th>
                        <th>Registrato</th>
                        <th>Azioni</th>
                    </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    <tr>
                        <td class="text-center py-4" colspan="6">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted">
                    Mostra <span id="usersShowing">0</span> di <span id="usersTotal">0</span> utenti
                </div>
                <nav>
                    <ul class="pagination mb-0" id="usersPagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Modal Nuovo/Modifica Utente -->
        <div class="modal fade" id="userModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user-plus me-2"></i>
                            <span id="userModalTitle">Nuovo Utente</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="userForm">
                            <input type="hidden" id="userId">

                            <!-- Nome e Cognome -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nome *</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Cognome *</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                </div>
                            </div>

                            <!-- Email e Telefono -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Telefono</label>
                                    <input type="tel" class="form-control" id="phone">
                                </div>
                            </div>

                            <!-- Password (solo per nuovo utente) -->
                            <div class="row mb-3" id="passwordSection">
                                <div class="col-md-6">
                                    <label class="form-label">Password *</label>
                                    <input type="password" class="form-control" id="password" required>
                                    <small class="text-muted">Min 8 caratteri con maiuscola, minuscola e numero</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Conferma Password *</label>
                                    <input type="password" class="form-control" id="confirmPassword" required>
                                </div>
                            </div>

                            <!-- Ruolo e Status -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Ruolo *</label>
                                    <select class="form-select" id="role" required>
                                        <option value="">Seleziona ruolo</option>
                                        <option value="client">Client</option>
                                        <option value="manager">Manager</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Status *</label>
                                    <select class="form-select" id="status" required>
                                        <option value="active">Attivo</option>
                                        <option value="inactive">Inattivo</option>
                                        <option value="suspended">Sospeso</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="button" class="btn btn-primary" onclick="saveUser()">
                            <i class="fas fa-save me-2"></i>Crea Utente
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEZIONE GESTIONE SPAZI PER ADMIN DASHBOARD -->
        <div class="admin-section" id="spacesSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>
                    <i class="fas fa-building text-primary me-2"></i>
                    Gestione Spazi
                </h4>
                <button class="btn btn-admin-primary" onclick="showAddSpaceModal()">
                    <i class="fas fa-plus me-2"></i>Nuovo Spazio
                </button>
            </div>

            <!-- Filtri e Ricerca -->
            <div class="admin-card mb-4">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Cerca Spazio</label>
                        <input class="form-control" id="spaceSearch" placeholder="Nome, città, indirizzo..."
                               type="text">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Città</label>
                        <select class="form-select" id="cityFilter">
                            <option value="">Tutte le città</option>
                            <option value="Milano">Milano</option>
                            <option value="Roma">Roma</option>
                            <option value="Torino">Torino</option>
                            <option value="Bologna">Bologna</option>
                            <option value="Napoli">Napoli</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" id="spaceTypeFilter">
                            <option value="">Tutti i tipi</option>
                            <option value="desk">Scrivania</option>
                            <option value="meeting_room">Sala Meeting</option>
                            <option value="private_office">Ufficio Privato</option>
                            <option value="coworking">Coworking</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="applySpaceFilters()">
                                <i class="fas fa-search"></i> Filtra
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetSpaceFilters()">
                                <i class="fas fa-refresh"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabella Spazi -->
            <div class="admin-table">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>Spazio</th>
                        <th>Città</th>
                        <th>Tipo</th>
                        <th>Capienza</th>
                        <th>Prezzo/h</th>
                        <th>Azioni</th>
                    </tr>
                    </thead>
                    <tbody id="spacesTableBody">
                    <tr>
                        <td class="text-center py-4" colspan="8">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Caricamento...</span>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginazione -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted">
                    Mostra <span id="spacesShowing">0</span> di <span id="spacesTotal">0</span> spazi
                </div>
                <nav>
                    <ul class="pagination mb-0" id="spacesPagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Modal per Nuovo/Modifica Spazio -->
        <div class="modal fade" id="spaceModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-building me-2"></i>
                            <span id="spaceModalTitle">Nuovo Spazio</span>
                        </h5>
                        <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
                    </div>
                    <div class="modal-body">
                        <form id="spaceForm">
                            <input id="spaceId" type="hidden">

                            <!-- Informazioni Base -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-info-circle me-2"></i>Informazioni Base
                                    </h6>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Nome Spazio *</label>
                                    <input class="form-control" id="spaceName" required type="text">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Tipo Spazio *</label>
                                    <select class="form-select" id="spaceType" required>
                                        <option value="">Seleziona tipo</option>
                                        <option value="hot-desk">Scrivania Condivisa</option>
                                        <option value="private-office">Ufficio Privato</option>
                                        <option value="meeting-room">Sala Meeting</option>
                                        <option value="event-space">Spazio Eventi</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Capienza *</label>
                                    <input class="form-control" id="spaceCapacity" max="100" min="1" required
                                           type="number">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Prezzo/Ora (€) *</label>
                                    <input class="form-control" id="spacePrice" min="0" required step="0.50"
                                           type="number">
                                </div>
                            </div>

                            <!-- Località -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-map-marker-alt me-2"></i>Località
                                    </h6>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Città *</label>
                                    <select class="form-select" id="spaceCity" required>
                                        <option value="">Seleziona città</option>
                                        <option value="Milano">Milano</option>
                                        <option value="Roma">Roma</option>
                                        <option value="Torino">Torino</option>
                                        <option value="Bologna">Bologna</option>
                                        <option value="Napoli">Napoli</option>
                                        <option value="Firenze">Firenze</option>
                                        <option value="Genova">Genova</option>
                                        <option value="Palermo">Palermo</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Indirizzo *</label>
                                    <input class="form-control" id="spaceAddress" required type="text">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">CAP</label>
                                    <input class="form-control" id="spacePostalCode" pattern="[0-9]{5}" type="text">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Piano</label>
                                    <input class="form-control" id="spaceFloor" placeholder="es. 2°, PT, -1"
                                           type="text">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Numero Stanza</label>
                                    <input class="form-control" id="spaceRoom" placeholder="es. A1, 205, Open Space"
                                           type="text">
                                </div>
                            </div>

                            <!-- Servizi -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-concierge-bell me-2"></i>Servizi Inclusi
                                    </h6>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" id="wifiService" type="checkbox">
                                        <label class="form-check-label" for="wifiService">
                                            <i class="fas fa-wifi me-2"></i>WiFi Gratuito
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" id="coffeeService" type="checkbox">
                                        <label class="form-check-label" for="coffeeService">
                                            <i class="fas fa-coffee me-2"></i>Caffè/Tè
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" id="printerService" type="checkbox">
                                        <label class="form-check-label" for="printerService">
                                            <i class="fas fa-print me-2"></i>Stampante
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" id="projectorService" type="checkbox">
                                        <label class="form-check-label" for="projectorService">
                                            <i class="fas fa-video me-2"></i>Proiettore
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" id="whiteboardService" type="checkbox">
                                        <label class="form-check-label" for="whiteboardService">
                                            <i class="fas fa-chalkboard me-2"></i>Lavagna
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" id="parkingService" type="checkbox">
                                        <label class="form-check-label" for="parkingService">
                                            <i class="fas fa-parking me-2"></i>Parcheggio
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" id="airConditioningService" type="checkbox">
                                        <label class="form-check-label" for="airConditioningService">
                                            <i class="fas fa-snowflake me-2"></i>Aria Condizionata
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" id="securityService" type="checkbox">
                                        <label class="form-check-label" for="securityService">
                                            <i class="fas fa-shield-alt me-2"></i>Sicurezza 24h
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Descrizione e Note -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-align-left me-2"></i>Descrizione
                                    </h6>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Descrizione Spazio *</label>
                                    <textarea class="form-control" id="spaceDescription" placeholder="Descrizione dettagliata dello spazio, atmosfera, particolarità..."
                                              rows="4" required></textarea>
                                </div>
                                <div class="col-12 mt-3">
                                    <label class="form-label">Note per Gestione</label>
                                    <textarea class="form-control" id="spaceNotes" placeholder="Note interne per la gestione dello spazio (non visibili ai clienti)"
                                              rows="2"></textarea>
                                </div>
                            </div>

                            <!-- Orari -->
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-clock me-2"></i>Orari di Disponibilità
                                    </h6>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Orario Apertura</label>
                                    <input class="form-control" id="spaceOpenTime" type="time" value="08:00">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Orario Chiusura</label>
                                    <input class="form-control" id="spaceCloseTime" type="time" value="20:00">
                                </div>
                                <div class="col-12 mt-3">
                                    <label class="form-label">Giorni Disponibili</label>
                                    <div class="d-flex gap-3 flex-wrap">
                                        <div class="form-check">
                                            <input checked class="form-check-input" id="dayMonday" type="checkbox">
                                            <label class="form-check-label" for="dayMonday">Lunedì</label>
                                        </div>
                                        <div class="form-check">
                                            <input checked class="form-check-input" id="dayTuesday" type="checkbox">
                                            <label class="form-check-label" for="dayTuesday">Martedì</label>
                                        </div>
                                        <div class="form-check">
                                            <input checked class="form-check-input" id="dayWednesday" type="checkbox">
                                            <label class="form-check-label" for="dayWednesday">Mercoledì</label>
                                        </div>
                                        <div class="form-check">
                                            <input checked class="form-check-input" id="dayThursday" type="checkbox">
                                            <label class="form-check-label" for="dayThursday">Giovedì</label>
                                        </div>
                                        <div class="form-check">
                                            <input checked class="form-check-input" id="dayFriday" type="checkbox">
                                            <label class="form-check-label" for="dayFriday">Venerdì</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" id="daySaturday" type="checkbox">
                                            <label class="form-check-label" for="daySaturday">Sabato</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" id="daySunday" type="checkbox">
                                            <label class="form-check-label" for="daySunday">Domenica</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Annulla</button>
                        <button class="btn btn-admin-primary" onclick="saveSpace()" type="button">
                            <i class="fas fa-save me-2"></i>Salva Spazio
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Dettagli Spazio -->
        <div class="modal fade" id="spaceDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-eye me-2"></i>Dettagli Spazio
                        </h5>
                        <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
                    </div>
                    <div class="modal-body" id="spaceDetailsContent">
                        <!-- Contenuto sarà popolato dinamicamente -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Chiudi</button>
                        <button class="btn btn-primary" onclick="editSpaceFromDetails()" type="button">
                            <i class="fas fa-edit me-2"></i>Modifica
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ==================== SPACES MANAGEMENT ====================

            let currentSpacePage = 1;
            let spacesData = [];

            // Load spaces when section is shown
            function loadSpaces(page = 1, filters = {}) {
                // Implementation will be added to main admin dashboard
                console.log('Loading spaces...', {page, filters});
            }

            // Space management functions
            function showAddSpaceModal() {
                document.getElementById('spaceModalTitle').textContent = 'Nuovo Spazio';
                document.getElementById('spaceId').value = '';
                document.getElementById('spaceForm').reset();

                // Set default values
                document.getElementById('spaceOpenTime').value = '08:00';
                document.getElementById('spaceCloseTime').value = '20:00';
                document.getElementById('wifiService').checked = true;

                // Check weekdays by default
                ['dayMonday', 'dayTuesday', 'dayWednesday', 'dayThursday', 'dayFriday'].forEach(day => {
                    document.getElementById(day).checked = true;
                });

                new bootstrap.Modal(document.getElementById('spaceModal')).show();
            }

            function applySpaceFilters() {
                const filters = {
                    search: document.getElementById('spaceSearch').value,
                    city: document.getElementById('cityFilter').value,
                    type: document.getElementById('spaceTypeFilter').value,
                    status: document.getElementById('spaceStatusFilter').value
                };

                // Filter object removing empty values
                const activeFilters = Object.fromEntries(
                    Object.entries(filters).filter(([_, value]) => value)
                );

                loadSpaces(1, activeFilters);
            }

            function resetSpaceFilters() {
                document.getElementById('spaceSearch').value = '';
                document.getElementById('cityFilter').value = '';
                document.getElementById('spaceTypeFilter').value = '';
                document.getElementById('spaceStatusFilter').value = '';
                loadSpaces(1);
            }

            function exportSpacesData() {
                // Implementation for exporting spaces data
                console.log('Exporting spaces data...');
                showNotification('Export in preparazione...', 'info');
            }

            function saveSpace() {
                const form = document.getElementById('spaceForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                // Collect form data
                const spaceData = {
                    name: document.getElementById('spaceName').value,
                    type: document.getElementById('spaceType').value,
                    capacity: parseInt(document.getElementById('spaceCapacity').value),
                    price_per_hour: parseFloat(document.getElementById('spacePrice').value),
                    city: document.getElementById('spaceCity').value,
                    address: document.getElementById('spaceAddress').value,
                    postal_code: document.getElementById('spacePostalCode').value,
                    floor: document.getElementById('spaceFloor').value,
                    room_number: document.getElementById('spaceRoom').value,
                    description: document.getElementById('spaceDescription').value,
                    notes: document.getElementById('spaceNotes').value,
                    open_time: document.getElementById('spaceOpenTime').value,
                    close_time: document.getElementById('spaceCloseTime').value,
                    available_days: getSelectedDays(),
                    services: getSelectedServices()
                };

                console.log('Saving space:', spaceData);
                // Implementation will be added to main admin dashboard
                showNotification('Spazio salvato con successo!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('spaceModal')).hide();
            }

            function getSelectedDays() {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                const dayIds = ['dayMonday', 'dayTuesday', 'dayWednesday', 'dayThursday', 'dayFriday', 'daySaturday', 'daySunday'];

                return days.filter((day, index) =>
                    document.getElementById(dayIds[index]).checked
                );
            }

            function getSelectedServices() {
                const services = [
                    {id: 'wifiService', name: 'wifi'},
                    {id: 'coffeeService', name: 'coffee'},
                    {id: 'printerService', name: 'printer'},
                    {id: 'projectorService', name: 'projector'},
                    {id: 'whiteboardService', name: 'whiteboard'},
                    {id: 'parkingService', name: 'parking'},
                    {id: 'airConditioningService', name: 'air_conditioning'},
                    {id: 'securityService', name: 'security'}
                ];

                return services
                    .filter(service => document.getElementById(service.id).checked)
                    .map(service => service.name);
            }

            console.log('📍 Admin Spaces Section loaded');
        </script>
        <div class="admin-section" id="bookingsSection" style="display: none;">
            <h4>Gestione Prenotazioni</h4>
            <p>Sezione in sviluppo...</p>
        </div>

        <div class="admin-section" id="analyticsSection" style="display: none;">
            <h4>Analytics</h4>
            <p>Sezione in sviluppo...</p>
        </div>

        <div class="admin-section" id="settingsSection" style="display: none;">
            <h4>Impostazioni Sistema</h4>
            <p>Sezione in sviluppo...</p>
        </div>
    </div>
</div>

<style>
    .admin-section .card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out;
    }

    .admin-section .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .admin-section .bg-primary {
        background: linear-gradient(45deg, #007bff, #0056b3) !important;
    }

    .admin-section .bg-info {
        background: linear-gradient(45deg, #17a2b8, #117a8b) !important;
    }

    .admin-section .bg-success {
        background: linear-gradient(45deg, #28a745, #1e7e34) !important;
    }

    .admin-section .bg-warning {
        background: linear-gradient(45deg, #ffc107, #d39e00) !important;
    }

    #dashboard-loading {
        backdrop-filter: blur(3px);
    }

    .opacity-75 {
        opacity: 0.75 !important;
    }

    .border-end {
        border-right: 1px solid #dee2e6 !important;
    }

    @media (max-width: 768px) {
        .border-end {
            border-right: none !important;
            border-bottom: 1px solid #dee2e6 !important;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
    }
</style>
`;

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/js/admin-dashboard-loader.js"></script>

<script>
    // Admin Dashboard JavaScript
    let currentPage = 1;
    let usersData = [];
    let filteredUsers = [];

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        initializeDashboard();
    });

    function initializeDashboard() {
        console.log('🚀 Initializing admin dashboard...');

        // Debug: mostra tutto il contenuto del localStorage
        console.log('🔍 localStorage contents:');
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            console.log(`  ${key}:`, key.includes('token') ? value.substring(0, 20) + '...' : value);
        }

        // Verifica token all'avvio
        if (!validateAuthToken()) {
            return; // La validazione ha già gestito l'errore
        }

        const userJson = localStorage.getItem('user');
        const user = JSON.parse(userJson);

        // Set admin name
        const adminUserNameEl = document.getElementById('adminUserName');
        if (adminUserNameEl && user) {
            const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
            adminUserNameEl.textContent = fullName || user.email || 'Admin';
            console.log('👤 Admin name set to:', adminUserNameEl.textContent);
        }

        // Carica dati iniziali
        loadDashboardStats();

        console.log('✅ Dashboard initialized successfully');
    }

    // Navigation
    function showSection(section) {
        // Verifica token prima di cambiare sezione
        if (!validateAuthToken()) {
            return;
        }

        // Nasconde tutte le sezioni
        document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');

        // Mostra la sezione richiesta
        const targetSection = document.getElementById(section + 'Section');
        if (targetSection) {
            targetSection.style.display = 'block';
        }

        // Carica i dati specifici per ogni sezione
        if (section === 'dashboard') {
            console.log('🎯 Loading dashboard section...');
            loadDashboardStats();
        } else if (section === 'users') {
            console.log('👥 Loading users section...');
            loadUsers(); // Carica gli utenti quando la sezione viene mostrata
        } else if (section === 'spaces') {
            console.log('🏢 Loading spaces section...');
            loadSpaces(); // Implementare se necessario
            fetchDashboardStats();
        }

        // Update active menu
        document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
        const activeLink = document.querySelector(`[onclick="showSection('${section}')"]`);
        if (activeLink) activeLink.classList.add('active');

        // Aggiorna il titolo della pagina
        const pageTitle = document.getElementById('pageTitle');
        if (pageTitle) {
            const titles = {
                'dashboard': 'Dashboard',
                'users': 'Gestione Utenti',
                'spaces': 'Gestione Spazi',
                'bookings': 'Prenotazioni',
                'analytics': 'Analytics',
                'settings': 'Impostazioni'
            };
            pageTitle.textContent = titles[section] || 'Dashboard';
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('adminSidebar');
        const main = document.getElementById('adminMain');

        if (window.innerWidth <= 768) {
            sidebar.classList.toggle('mobile-open');
        } else {
            sidebar.classList.toggle('collapsed');
            main.classList.toggle('expanded');
        }
    }

    // Dashboard Stats
    async function loadDashboardStats() {
        try {
            console.log('🚀 Loading dashboard stats...');
            const token = localStorage.getItem('auth_token');

            if (!token) {
                console.error('❌ No auth token found');
                return;
            }

            const response = await fetch('http://localhost:3000/api/analytics/dashboard/admin', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('📊 API Response status:', response.status);

            if (response.ok) {
                const result = await response.json();
                console.log('📊 API response:', result.success);

                if (result.success && result.data) {
                    // Aggiorna statistiche generali
                    if (result.data.general) {
                        console.log('📈 Updating general stats...');
                        updateDashboardStats(result.data.general);
                    }

                    // Aggiorna top spazi
                    if (result.data.topSpaces) {
                        console.log('🏆 Updating top spaces...');
                        updateTopSpaces(result.data.topSpaces);
                    } else {
                        console.warn('⚠️ No topSpaces in response');
                        updateTopSpaces([]);
                    }

                    console.log('✅ Dashboard loaded successfully');
                }
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

        } catch (error) {
            console.error('❌ Error loading dashboard stats:', error);

            // Mostra errore nel container dei top spazi
            const container = document.getElementById('top-spaces-list');
            if (container) {
                container.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p class="mb-1">Errore nel caricamento</p>
                    <small>${error.message}</small>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadDashboardStats()">
                            <i class="fas fa-redo me-1"></i>Riprova
                        </button>
                    </div>
                </div>
            `;
            }
        }
    }

    function updateTopSpaces(topSpaces) {
        console.log('🏆 Updating top spaces:', topSpaces);

        const container = document.getElementById('top-spaces-list');

        if (!container) {
            console.error('❌ Container top-spaces-list not found!');
            return;
        }

        if (!topSpaces || topSpaces.length === 0) {
            container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-building fa-2x mb-2 text-secondary"></i>
                <p class="mb-1">Nessun dato disponibile</p>
                <small class="text-muted">I top spazi appariranno quando ci saranno delle prenotazioni</small>
            </div>
        `;
            return;
        }

        // Ordina per prenotazioni totali (decrescente)
        const sortedSpaces = [...topSpaces].sort((a, b) => b.bookings.total - a.bookings.total);

        const spacesHtml = sortedSpaces.map((space, index) => {
            const badgeColors = ['bg-warning', 'bg-info', 'bg-success', 'bg-secondary', 'bg-dark'];
            const badgeColor = badgeColors[index] || 'bg-secondary';

            return `
            <div class="d-flex justify-content-between align-items-center py-3 ${index < sortedSpaces.length - 1 ? 'border-bottom' : ''}">
                <div class="d-flex align-items-center">
                    <div class="badge ${badgeColor} me-3 d-flex align-items-center justify-content-center"
                         style="width: 32px; height: 32px; border-radius: 50%; font-size: 14px; font-weight: bold;">
                        ${index + 1}
                    </div>
                    <div>
                        <h6 class="mb-1 fw-bold" style="font-size: 0.9rem;">${space.name}</h6>
                        <small class="text-muted" style="font-size: 0.75rem;">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            ${space.location}
                        </small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-primary mb-1" style="font-size: 0.85rem;">
                        <i class="fas fa-calendar-check me-1"></i>
                        ${space.bookings.total} prenotazioni
                    </div>
                    <div class="d-flex flex-column">
                        <small class="text-muted" style="font-size: 0.7rem;">
                            <i class="fas fa-euro-sign me-1"></i>€${space.revenue.toFixed(2)}
                        </small>
                        <small class="text-success" style="font-size: 0.7rem;">
                            <i class="fas fa-check-circle me-1"></i>
                            ${space.bookings.total} confermate
                        </small>
                    </div>
                </div>
            </div>
        `;
        }).join('');

        container.innerHTML = spacesHtml;
        console.log(`✅ Rendered ${sortedSpaces.length} top spaces successfully`);
    }

    function updateDashboardStats(stats) {
        console.log('📈 Updating dashboard stats with your specific IDs:', stats);

        if (!stats) {
            console.warn('⚠️ No stats provided');
            return;
        }

        // Mapping ottimizzato per i tuoi ID specifici
        const updates = {
            'total-users': stats.users?.total || 0,
            'new-users': stats.users?.new || 0,
            'total-spaces': stats.spaces?.total || 0,
            'total-bookings': stats.bookings?.total || 0,
            'confirmed-bookings': stats.bookings?.total || 0,
            'total-revenue': `€${(stats.revenue?.total || 0).toFixed(2)}`,
            'total-payments': stats.revenue?.payments || 0,
            'average-transaction': `€${stats.revenue?.averageTransaction || 0}`
        };

        // Aggiorna tutti gli elementi
        Object.entries(updates).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
                console.log(`✅ Updated ${id}: ${value}`);
            } else {
                console.warn(`⚠️ Element ${id} not found`);
            }
        });
    }

    // Auto-refresh ogni 2 minuti (opzionale)
    let dashboardRefreshInterval;

    function startDashboardAutoRefresh() {
        // Pulisci interval precedente se esiste
        if (dashboardRefreshInterval) {
            clearInterval(dashboardRefreshInterval);
        }

        // Auto-refresh ogni 2 minuti se la dashboard è visibile
        dashboardRefreshInterval = setInterval(() => {
            const dashboardSection = document.getElementById('dashboardSection');
            if (dashboardSection && dashboardSection.style.display !== 'none') {
                console.log('🔄 Auto-refreshing dashboard...');
                loadDashboardStats();
            }
        }, 120000); // 2 minuti
    }

    // Inizializza quando il DOM è pronto
    document.addEventListener('DOMContentLoaded', function() {
        console.log('📄 DOM loaded');

        // Se la dashboard è già visibile, carica i dati
        const dashboardSection = document.getElementById('dashboardSection');
        if (dashboardSection && dashboardSection.style.display !== 'none') {
            setTimeout(loadDashboardStats, 1000);
        }

        // Avvia auto-refresh
        startDashboardAutoRefresh();
    });

    // Users Management
    async function loadUsers(page = 1, filters = {}) {
        try {
            // Verifica token prima di fare la chiamata
            if (!validateAuthToken()) {
                return; // La validazione ha già gestito l'errore
            }

            const token = localStorage.getItem('auth_token');

            // Mostra loading
            showUsersLoading();

            const params = new URLSearchParams({
                page: page,
                limit: 10,
                ...filters
            });

            console.log('🔄 Loading users with params:', params.toString());

            const response = await fetch(`http://localhost:3000/api/users?${params}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            console.log('📊 Users API response status:', response.status);

            // Gestione specifica per errore 401
            if (response.status === 401) {
                const errorData = await response.json().catch(() => ({}));
                console.error('❌ 401 Unauthorized:', errorData);

                // Token non valido o scaduto
                clearAuthAndRedirect(errorData.message || 'Token non valido');
                return;
            }

            // Gestione altri errori HTTP
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('📊 Users data received:', data);

            if (data.success && data.users) {
                usersData = data.users;
                currentPage = data.currentPage || page;

                renderUsersTable(data.users);
                renderUsersPagination(data.totalPages || 1, data.total || data.totalUsers || 0);

                console.log('✅ Users loaded successfully');
            } else {
                throw new Error(data.message || 'Errore nel formato dei dati');
            }

        } catch (error) {
            console.error('❌ Error loading users:', error);

            // Non mostrare l'errore se abbiamo già reindirizzato
            if (error.message.includes('Token')) {
                return;
            }

            showNotification('Errore nel caricamento degli utenti: ' + error.message, 'error');
            showUsersError(error.message);
        }
    }

    function validateAuthToken() {
        const token = localStorage.getItem('auth_token');
        const userJson = localStorage.getItem('user');  // Verifica 'user' invece di 'user_data'

        console.log('🔍 Checking auth token:', {
            hasToken: !!token,
            hasUser: !!userJson,
            tokenLength: token ? token.length : 0,
            userJson: userJson
        });

        // Verifica se il token esiste
        if (!token) {
            console.error('❌ No auth token found');
            redirectToLogin('Token mancante');
            return false;
        }

        // Verifica se i dati utente esistono
        if (!userJson) {
            console.error('❌ No user data found in localStorage');
            clearAuthAndRedirect('Dati utente mancanti');
            return false;
        }

        let user;
        try {
            user = JSON.parse(userJson);
            console.log('📊 Parsed user data:', user);
        } catch (error) {
            console.error('❌ Error parsing user data:', error);
            clearAuthAndRedirect('Dati utente corrotti');
            return false;
        }

        // Verifica formato del token (dovrebbe essere un JWT)
        const jwtRegex = /^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/;
        if (!jwtRegex.test(token)) {
            console.error('❌ Invalid JWT format');
            clearAuthAndRedirect('Token malformato');
            return false;
        }

        // Verifica se l'utente è admin
        if (!user || !user.role || user.role !== 'admin') {
            console.error('❌ User is not admin:', user);
            redirectToLogin('Accesso non autorizzato - Solo amministratori');
            return false;
        }

        // Verifica se il token è scaduto (opzionale)
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const currentTime = Math.floor(Date.now() / 1000);

            if (payload.exp && payload.exp < currentTime) {
                console.error('❌ Token expired');
                clearAuthAndRedirect('Token scaduto');
                return false;
            }

            console.log('✅ Token validation passed');
            return true;
        } catch (error) {
            console.error('❌ Error parsing token:', error);
            clearAuthAndRedirect('Token corrotto');
            return false;
        }
    }

    // 2. Funzione per pulire l'autenticazione e reindirizzare
    function clearAuthAndRedirect(reason) {
        console.log('🚪 Clearing auth and redirecting:', reason);
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user');
        localStorage.removeItem('refresh_token'); // Se presente

        alert(`Sessione non valida: ${reason}. Effettua il login nuovamente.`);
        window.location.href = '../index.html';
    }

    // 3. Funzione per reindirizzare al login
    function redirectToLogin(reason) {
        console.log('🚪 Redirecting to login:', reason);
        alert(`${reason}. Effettua il login.`);
        window.location.href = '../index.html';
    }

    function showUsersLoading() {
        const tbody = document.getElementById('usersTableBody');
        if (tbody) {
            tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Caricamento...</span>
                    </div>
                    <p class="mt-2 mb-0">Caricamento utenti...</p>
                </td>
            </tr>
        `;
        }
    }

    function showUsersError(message) {
        const tbody = document.getElementById('usersTableBody');
        if (tbody) {
            tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-warning fa-2x mb-3"></i>
                    <p class="mb-2">${message}</p>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadUsers()">
                        <i class="fas fa-redo me-1"></i>Riprova
                    </button>
                </td>
            </tr>
        `;
        }
    }

    function renderUsersTable(users) {
        const tbody = document.getElementById('usersTableBody');

        if (!tbody) {
            console.error('❌ Element #usersTableBody not found');
            return;
        }

        if (!users || users.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="fas fa-users text-muted fa-2x mb-3"></i>
                    <p class="mb-0">Nessun utente trovato</p>
                </td>
            </tr>
        `;
            return;
        }

        tbody.innerHTML = users.map(user => {
            const firstName = user.first_name || user.firstName || '';
            const lastName = user.last_name || user.lastName || '';
            const fullName = `${firstName} ${lastName}`.trim() || 'Nome non disponibile';
            const initials = getAvatarInitials(firstName, lastName);

            return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar me-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-weight: bold;">
                                ${initials}
                            </div>
                        </div>
                        <div>
                            <div class="fw-semibold">${fullName}</div>
                            <small class="text-muted">ID: ${user.id}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div>${user.email}</div>
                    ${user.phone ? `<small class="text-muted">${user.phone}</small>` : ''}
                </td>
                <td><span class="role-badge role-${user.role}">${user.role}</span></td>
                <td><span class="status-badge status-${user.status}">${user.status}</span></td>
                <td>${formatDate(user.created_at || user.createdAt)}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" onclick="editUser('${user.id}')" title="Modifica">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="viewUser('${user.id}')" title="Visualizza">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${user.role !== 'admin' ? `
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Più azioni">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="toggleUserStatus('${user.id}', '${user.status}')">
                                        <i class="fas fa-toggle-${user.status === 'active' ? 'off' : 'on'} me-2"></i>
                                        ${user.status === 'active' ? 'Sospendi' : 'Attiva'}
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteUser('${user.id}')">
                                        <i class="fas fa-trash me-2"></i>Elimina
                                    </a></li>
                                </ul>
                            </div>
                        ` : `
                            <button class="btn btn-outline-secondary" disabled title="Admin non modificabile">
                                <i class="fas fa-lock"></i>
                            </button>
                        `}
                    </div>
                </td>
            </tr>
        `;
        }).join('');

        console.log(`✅ Rendered ${users.length} users in table`);
    }

    function getAvatarInitials(firstName, lastName) {
        const first = (firstName || '').charAt(0).toUpperCase();
        const last = (lastName || '').charAt(0).toUpperCase();
        return first + last || 'U';
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            return new Date(dateString).toLocaleDateString('it-IT');
        } catch (error) {
            return 'N/A';
        }
    }

    function editUser(userId) {
        showEditUserModal(userId);
    }

    function viewUser(userId) {
        console.log('View user:', userId);
        const user = usersData.find(u => u.id === userId);
        if (user) {
            const details = `
                Nome: ${user.first_name || user.firstName || ''} ${user.last_name || user.lastName || ''}
                Email: ${user.email}
                Ruolo: ${user.role}
                Status: ${user.status}
                Registrato: ${formatDate(user.created_at || user.createdAt)}
            `.trim();
            alert(details);
        }
    }

    // Aggiungi questa funzione insieme alle altre funzioni JavaScript
    async function toggleUserStatus(userId, currentStatus) {
        console.log('Toggle user status called:', { userId, currentStatus });

        const user = usersData.find(u => u.id === userId);
        const userName = user ? `${user.first_name || user.firstName || ''} ${user.last_name || user.lastName || ''}`.trim() : 'Utente';
        const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
        const action = newStatus === 'active' ? 'attivare' : 'sospendere';

        if (!confirm(`Confermi di voler ${action} l'utente "${userName}"?`)) {
            return;
        }

        try {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                throw new Error('Token mancante');
            }

            const response = await fetch(`http://localhost:3000/api/users/${userId}/status`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (response.ok) {
                showNotification(`Utente ${action === 'attivare' ? 'attivato' : 'sospeso'} con successo`, 'success');
                loadUsers(currentPage || 1, getCurrentUserFilters());
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Errore aggiornamento status');
            }
        } catch (error) {
            console.error('Error toggling user status:', error);
            showNotification('Errore: ' + error.message, 'error');
        }
    }

    async function suspendUser(userId) {
        const user = usersData.find(u => u.id === userId);
        const userName = user ? `${user.first_name || user.firstName || ''} ${user.last_name || user.lastName || ''}`.trim() : 'Utente';

        if (!confirm(`Confermi di voler sospendere l'utente "${userName || user?.email}"?`)) {
            return;
        }

        try {
            const token = localStorage.getItem('auth_token');
            const response = await fetch(`http://localhost:3000/api/users/${userId}/status`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'suspended' })
            });

            if (response.ok) {
                showNotification('Utente sospeso con successo', 'success');
                loadUsers(currentPage || 1, getCurrentUserFilters());
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Errore nella sospensione');
            }
        } catch (error) {
            console.error('Error suspending user:', error);
            showNotification('Errore nella sospensione dell\'utente: ' + error.message, 'error');
        }
    }

    // Funzione per riattivare utente (alternativa diretta)
    async function activateUser(userId) {
        const user = usersData.find(u => u.id === userId);
        const userName = user ? `${user.first_name || user.firstName || ''} ${user.last_name || user.lastName || ''}`.trim() : 'Utente';

        if (!confirm(`Confermi di voler riattivare l'utente "${userName || user?.email}"?`)) {
            return;
        }

        try {
            const token = localStorage.getItem('auth_token');
            const response = await fetch(`http://localhost:3000/api/users/${userId}/status`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'active' })
            });

            if (response.ok) {
                showNotification('Utente riattivato con successo', 'success');
                loadUsers(currentPage || 1, getCurrentUserFilters());
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Errore nella riattivazione');
            }
        } catch (error) {
            console.error('Error activating user:', error);
            showNotification('Errore nella riattivazione dell\'utente: ' + error.message, 'error');
        }
    }

    function renderUsersPagination(totalPages, totalUsers) {
        const pagination = document.getElementById('usersPagination');
        const showing = document.getElementById('usersShowing');
        const total = document.getElementById('usersTotal');

        // Update counters
        const startItem = ((currentPage - 1) * 10) + 1;
        const endItem = Math.min(currentPage * 10, totalUsers);
        showing.textContent = `${startItem}-${endItem}`;
        total.textContent = totalUsers;

        // Generate pagination
        let paginationHTML = '';

        // Previous button
        paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadUsers(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadUsers(1)">1</a></li>`;
            if (startPage > 2) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadUsers(${i})">${i}</a>
                    </li>
                `;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadUsers(${totalPages})">${totalPages}</a></li>`;
        }

        // Next button
        paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadUsers(${currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

        pagination.innerHTML = paginationHTML;
    }

    // User Management Actions
    function showAddUserModal() {
        console.log('Opening new user modal');

        // Controlla se la modal esiste
        const modal = document.getElementById('userModal');
        if (!modal) {
            alert('Modal non trovata nell\'HTML!');
            return;
        }

        // Reset form se esiste
        const form = document.getElementById('userForm');
        if (form) form.reset();

        // Imposta valori solo se gli elementi esistono
        const titleEl = document.getElementById('userModalTitle');
        if (titleEl) titleEl.textContent = 'Nuovo Utente';

        const userIdEl = document.getElementById('userId');
        if (userIdEl) userIdEl.value = '';

        // Mostra modal
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
    }

    function showEditUserModal(userId) {
        console.log('Opening edit user modal for:', userId);

        const user = usersData.find(u => u.id === userId);
        if (!user) {
            showNotification('Utente non trovato', 'error');
            return;
        }

        // Popola form con dati utente
        document.getElementById('userId').value = user.id;
        document.getElementById('firstName').value = user.first_name || user.firstName || '';
        document.getElementById('lastName').value = user.last_name || user.lastName || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('phone').value = user.phone || '';
        document.getElementById('role').value = user.role || 'client';
        document.getElementById('status').value = user.status || 'active';
        document.getElementById('company').value = user.company || '';

        // Imposta titoli per modifica
        document.getElementById('userModalTitle').textContent = 'Modifica Utente';
        document.getElementById('saveButtonText').textContent = 'Salva Modifiche';

        // Nascondi sezione password per modifica
        document.getElementById('passwordSection').style.display = 'none';
        document.getElementById('password').required = false;
        document.getElementById('confirmPassword').required = false;

        // Mostra modal
        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        modal.show();
    }

    async function saveUser() {
        console.log('Saving user...');

        // Controlla che tutti gli elementi esistano
        const requiredElements = ['firstName', 'lastName', 'email', 'role', 'status'];
        for (const id of requiredElements) {
            if (!document.getElementById(id)) {
                alert(`Elemento mancante nell'HTML: ${id}`);
                return;
            }
        }

        const form = document.getElementById('userForm');
        const userId = document.getElementById('userId')?.value || '';
        const isEdit = !!userId;

        // Validazione form
        if (!form || !form.checkValidity()) {
            if (form) form.reportValidity();
            return;
        }

        // Validazione password per nuovo utente
        if (!isEdit) {
            const passwordEl = document.getElementById('password');
            const confirmPasswordEl = document.getElementById('confirmPassword');

            if (!passwordEl || !confirmPasswordEl) {
                alert('Campi password mancanti nell\'HTML');
                return;
            }

            const password = passwordEl.value;
            const confirmPassword = confirmPasswordEl.value;

            if (password !== confirmPassword) {
                alert('Le password non corrispondono');
                return;
            }

            if (password.length < 8) {
                alert('La password deve essere di almeno 8 caratteri');
                return;
            }
        }

        // Raccogli dati in modo sicuro
        const userData = {
            first_name: document.getElementById('firstName')?.value?.trim() || '',
            last_name: document.getElementById('lastName')?.value?.trim() || '',
            email: document.getElementById('email')?.value?.trim() || '',
            phone: document.getElementById('phone')?.value?.trim() || null,
            role: document.getElementById('role')?.value || 'client',
            status: document.getElementById('status')?.value || 'active'
        };

        // Aggiungi password solo per nuovo utente
        if (!isEdit) {
            userData.password = document.getElementById('password')?.value || '';
        }

        console.log('User data to save:', userData);

        try {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                alert('Token di accesso mancante');
                return;
            }

            const url = isEdit
                ? `http://localhost:3000/api/users/${userId}`
                : 'http://localhost:3000/api/users';

            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            });

            if (response.ok) {
                const result = await response.json();
                console.log('User save successful:', result);

                // Chiudi modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                if (modal) modal.hide();

                alert('Utente creato con successo!');

                // Ricarica tabella
                if (typeof loadUsers === 'function') {
                    loadUsers(currentPage || 1, getCurrentUserFilters());
                } else {
                    location.reload();
                }

            } else {
                const errorData = await response.json();
                alert('Errore: ' + (errorData.message || 'Errore sconosciuto'));
            }

        } catch (error) {
            console.error('Error saving user:', error);
            alert('Errore nel salvataggio: ' + error.message);
        }
    }

    // Filters
    function applyUserFilters() {
        const search = document.getElementById('userSearch').value;
        const role = document.getElementById('roleFilter').value;
        const status = document.getElementById('statusFilter').value;

        const filters = {};
        if (search) filters.search = search;
        if (role) filters.role = role;
        if (status) filters.status = status;

        loadUsers(1, filters);
    }

    // Funzione per eliminare un utente
    async function deleteUser(userId) {
        console.log('Attempting to delete user:', userId);

        // Trova l'utente per mostrare il nome nella conferma
        const user = usersData.find(u => u.id === userId);
        const userName = user ? `${user.first_name || user.firstName || ''} ${user.last_name || user.lastName || ''}`.trim() : 'Utente';
        const userEmail = user ? user.email : 'sconosciuto';

        // Conferma eliminazione
        const confirmMessage = `Sei sicuro di voler eliminare l'utente?\n\nNome: ${userName || 'N/A'}\nEmail: ${userEmail}\n\nQuesta azione non può essere annullata.`;

        if (!confirm(confirmMessage)) {
            return;
        }

        try {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                throw new Error('Token di accesso mancante');
            }

            console.log('Making DELETE request for user:', userId);

            const response = await fetch(`http://localhost:3000/api/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.status === 401) {
                clearAuthAndRedirect('Sessione scaduta');
                return;
            }

            if (response.ok) {
                const result = await response.json();
                console.log('Delete successful:', result);

                showNotification(`Utente "${userName || userEmail}" eliminato con successo`, 'success');

                // Ricarica la tabella utenti
                loadUsers(currentPage || 1, getCurrentUserFilters());

            } else {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `Errore HTTP ${response.status}`);
            }

        } catch (error) {
            console.error('Error deleting user:', error);
            showNotification(`Errore nell'eliminazione dell'utente: ${error.message}`, 'error');
        }
    }

    async function confirmUserDeletion(userId) {
        try {
            // Carica dettagli utente aggiuntivi se necessario
            const token = localStorage.getItem('auth_token');
            const response = await fetch(`http://localhost:3000/api/users/${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const result = await response.json();
                const user = result.user || result.data;

                if (user) {
                    const confirmHtml = `
                    <div style="text-align: left; padding: 10px;">
                        <h4>Conferma Eliminazione Utente</h4>
                        <hr>
                        <p><strong>Nome:</strong> ${user.first_name || user.firstName || ''} ${user.last_name || user.lastName || ''}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Ruolo:</strong> ${user.role}</p>
                        <p><strong>Status:</strong> ${user.status}</p>
                        <p><strong>Registrato:</strong> ${new Date(user.created_at || user.createdAt).toLocaleDateString('it-IT')}</p>
                        <hr>
                        <p style="color: red;"><strong>⚠️ ATTENZIONE:</strong> Questa azione eliminerà permanentemente:</p>
                        <ul>
                            <li>Tutti i dati personali dell'utente</li>
                            <li>Le prenotazioni associate (verranno annullate)</li>
                            <li>I pagamenti collegati</li>
                        </ul>
                        <p><strong>Questa azione NON può essere annullata!</strong></p>
                    </div>
                `;

                    // Usa una modal Bootstrap se disponibile, altrimenti usa confirm
                    if (typeof bootstrap !== 'undefined') {
                        showDeleteConfirmationModal(userId, confirmHtml);
                    } else {
                        const confirmed = confirm(`Elimina utente ${user.email}?\n\nQuesta azione non può essere annullata.`);
                        if (confirmed) {
                            await deleteUser(userId);
                        }
                    }
                }
            } else {
                // Fallback alla funzione delete standard
                await deleteUser(userId);
            }
        } catch (error) {
            console.error('Error loading user details:', error);
            // Fallback alla funzione delete standard
            await deleteUser(userId);
        }
    }

    // Funzione per mostrare modal di conferma (se Bootstrap è disponibile)
    function showDeleteConfirmationModal(userId, content) {
        // Crea modal dinamicamente
        const modalHtml = `
        <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Conferma Eliminazione</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="button" class="btn btn-danger" onclick="proceedWithDelete('${userId}')">
                            <i class="fas fa-trash me-2"></i>Elimina Definitivamente
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Rimuovi modal esistente se presente
        const existingModal = document.getElementById('deleteConfirmModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Aggiungi nuovo modal
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Mostra modal
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    }

    // Funzione per procedere con l'eliminazione dalla modal
    async function proceedWithDelete(userId) {
        // Chiudi modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        if (modal) {
            modal.hide();
        }

        // Procedi con l'eliminazione
        await deleteUser(userId);
    }

    console.log('🗑️ Delete user functions loaded');

    // Funzione helper per ottenere i filtri correnti
    function getCurrentUserFilters() {
        return {
            search: document.getElementById('userSearch')?.value || '',
            role: document.getElementById('roleFilter')?.value || '',
            status: document.getElementById('statusFilter')?.value || ''
        };
    }

    // Utility Functions
    function showNotification(message, type = 'info') {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.admin-notification');
        existingNotifications.forEach(notification => notification.remove());

        // Create new notification
        const notification = document.createElement('div');
        notification.className = `admin-notification alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;

        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    function logout() {
        if (confirm('Sei sicuro di voler uscire?')) {
            console.log('👋 Logging out...');

            // Pulisci tutto lo storage
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            localStorage.removeItem('refresh_token');
            sessionStorage.clear();

            // Reindirizza
            window.location.href = '../index.html';
        }
    }

    function setupGlobalAuthInterceptor() {
        // Override del fetch globale per gestire automaticamente i 401
        const originalFetch = window.fetch;

        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);

                // Se riceviamo un 401, gestiscilo automaticamente
                if (response.status === 401) {
                    console.warn('🔒 Received 401, clearing auth');
                    const errorData = await response.clone().json().catch(() => ({}));
                    clearAuthAndRedirect(errorData.message || 'Sessione scaduta');
                    return response; // Ritorna comunque la response per evitare errori
                }

                return response;
            } catch (error) {
                console.error('❌ Fetch error:', error);
                throw error;
            }
        };
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('📄 DOM loaded, checking admin dashboard...');

        // Verifica se siamo sulla pagina admin
        if (document.getElementById('adminSidebar')) {
            setupGlobalAuthInterceptor();
            initializeDashboard();

            // Auto-refresh del token ogni 30 minuti (opzionale)
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    validateAuthToken();
                }
            }, 30 * 60 * 1000);
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
        // Alt + U = Users section
        if (e.altKey && e.key === 'u') {
            e.preventDefault();
            showSection('users');
        }

        // Alt + D = Dashboard
        if (e.altKey && e.key === 'd') {
            e.preventDefault();
            showSection('dashboard');
        }

        // Ctrl + N = New user (when in users section)
        if (e.ctrlKey && e.key === 'n' && document.getElementById('usersSection').style.display !== 'none') {
            e.preventDefault();
            showAddUserModal();
        }
    });

    // Handle form submissions with Enter key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            if (e.target.id === 'userSearch') {
                e.preventDefault();
                applyUserFilters();
            }
        }
    });

    // Responsive handling
    window.addEventListener('resize', function () {
        if (window.innerWidth > 768) {
            document.getElementById('adminSidebar').classList.remove('mobile-open');
        }
    });

    // Auto-refresh data every 30 seconds
    setInterval(() => {
        if (document.getElementById('dashboardSection').style.display !== 'none') {
            loadDashboardStats();
        }
    }, 30000);


    // Aggiorna timestamp ultimo aggiornamento
    function updateLastUpdate() {
        const element = document.getElementById('last-update');
        if (element) {
            element.textContent = new Date().toLocaleTimeString('it-IT');
        }
    }

    // Aggiorna timestamp ogni minuto
    setInterval(updateLastUpdate, 60000);
    updateLastUpdate(); // Prima chiamata immediata

    console.log('🎯 Admin Dashboard HTML loaded and ready');

    document.addEventListener('DOMContentLoaded', function() {
        // Se siamo sulla pagina admin, esegui il debug
        if (document.getElementById('adminSidebar')) {
            console.log('📍 Admin dashboard page detected');
            initializeDashboard();
        }
    });
</script>

<script>
    setTimeout(() => {
        fetch('http://localhost:3000/api/analytics/dashboard/admin')
            .then(r => r.json())
            .then(data => {
                console.log('📊 Dashboard response:', data);

                // Controlla se la risposta è valida
                if (data.success && data.data && data.data.general) {
                    const stats = data.data.general;

                    const updates = {
                        'total-users': stats.users.total,
                        'new-users': stats.users.new,
                        'total-spaces': stats.spaces.total,
                        'total-bookings': stats.bookings.total,
                        'confirmed-bookings': stats.bookings.total,
                        'total-revenue': '€' + stats.revenue.total.toFixed(2),
                        'total-payments': stats.revenue.payments
                    };

                    Object.entries(updates).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                            console.log(`✅ Updated ${id}: ${value}`);
                        }
                    });
                } else {
                    console.error('❌ Invalid response structure:', data);
                }

              if (data.data.revenue && data.data.revenue.dailyRevenue) {
                console.log('Creating chart with data:', data.data.revenue.dailyRevenue);

                const ctx = document.getElementById('revenueChartCanvas');
                if (ctx) {
                  // Distruggi grafico esistente se presente
                  if (window.revenueChart) {
                    window.revenueChart.destroy();
                  }

                  // Prepara i dati
                  const labels = data.data.revenue.dailyRevenue.map(day =>
                          new Date(day.date).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' })
                  );
                  const revenues = data.data.revenue.dailyRevenue.map(day => day.revenue);

                  // Crea il grafico
                  window.revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                      labels: labels,
                      datasets: [{
                        label: 'Revenue (€)',
                        data: revenues,
                        borderColor: 'rgba(40, 167, 69, 1)',
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        fill: false
                      }]
                    },
                    options: {
                      responsive: true,
                      scales: {
                        y: {
                          beginAtZero: true
                        }
                      },
                      elements: {
                        point: {
                          radius: 6,
                          hoverRadius: 8
                        }
                      }
                    }
                  });
                }
              }

              // Dopo l'aggiornamento degli altri elementi, aggiungi:
              if (data.data.revenue && data.data.revenue.totals) {
                const totals = data.data.revenue.totals;

                const currentEl = document.getElementById('current-revenue');
                const previousEl = document.getElementById('previous-revenue');
                const growthEl = document.getElementById('revenue-growth');

                if (currentEl) currentEl.textContent = '€' + totals.current.toFixed(2);
                if (previousEl) previousEl.textContent = '€' + totals.previous.toFixed(2);
                if (growthEl) {
                  const isPositive = totals.growthRate >= 0;
                  growthEl.innerHTML = `<span class="${isPositive ? 'text-success' : 'text-danger'}">
                      ${isPositive ? '+' : ''}${totals.growthRate.toFixed(1)}%
                  </span>`;
                }
              }

            })
            .catch(err => console.error('❌ Dashboard error:', err));
    }, 1000);
</script>

<script>
    // Sezione spazi
    const spacesTableBody = document.getElementById('spacesTableBody');
    const totalSpacesCountEl = document.getElementById('totalSpacesCount');
    const activeSpacesCountEl = document.getElementById('activeSpacesCount');

    // Funzione per caricare gli spazi
    async function loadSpaces(filters = {}) {
        showLoadingState();
        try {
            const token = localStorage.getItem('auth_token'); // Recupera il token da localStorage
            if (!token) {
                console.error('Token di autenticazione mancante.');
                showErrorState('Accesso negato. Effettua il login.');
                return;
            }

            // Costruisce la stringa di query dai filtri
            const queryString = new URLSearchParams(filters).toString();

            // Aggiunge la stringa di query all'URL della tua API
            const response = await fetch(`http://localhost:3000/api/spaces/all?${queryString}`, {
                headers: {
                    'Authorization': `Bearer ${token}` // Invia il token nell'header
                }
            });

            const data = await response.json();
            if (data.success) {
                renderSpacesTable(data.spaces);
                updateSpacesStats(data.spaces);
            } else {
                showErrorState(data.message || 'Errore durante il caricamento degli spazi.');
            }
        } catch (error) {
            console.error('Errore nel caricamento degli spazi:', error);
            showErrorState('Impossibile caricare gli spazi. Riprova più tardi.');
        }
    }

    async function loadTopSpaces() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('Token non trovato. Impossibile caricare i top spazi.');
                return;
            }

            const topSpacesResponse = await fetch('/api/spaces/top-spaces', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!topSpacesResponse.ok) {
                throw new Error('Errore nel caricamento dei top spazi');
            }

            const topSpacesData = await topSpacesResponse.json();
            const topSpacesList = document.getElementById('top-spaces-list');
            topSpacesList.innerHTML = ''; // Pulisce il messaggio di caricamento

            if (topSpacesData.success && topSpacesData.spaces.length > 0) {
                topSpacesData.spaces.forEach(space => {
                    const spaceItem = document.createElement('div');
                    spaceItem.className = 'd-flex align-items-center mb-3';
                    spaceItem.innerHTML = `
                    <div class="me-3 text-warning">
                        <i class="fas fa-trophy fa-2x"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">${space.name}</h6>
                        <small class="text-muted">Prenotazioni: ${space.bookings_count}</small>
                    </div>
                `;
                    topSpacesList.appendChild(spaceItem);
                });
            } else {
                topSpacesList.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                    <p>Nessun top spazio trovato.</p>
                </div>
            `;
            }

        } catch (error) {
            console.error('Errore nel caricamento dei top spazi:', error);
            const topSpacesList = document.getElementById('top-spaces-list');
            topSpacesList.innerHTML = `
            <div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>Errore. Impossibile caricare i top spazi.</p>
            </div>
        `;
        }
    }

    async function fetchDashboardStats() {
        const loadingEl = document.getElementById('dashboard-loading');
        const errorEl = document.getElementById('dashboard-error');

        loadingEl.style.display = 'flex';
        errorEl.style.display = 'none';

        try {
            const response = await fetch('/api/spaces/stats');
            const data = await response.json();

            if (data.success) {
                updateSpacesStats(data.stats);
            } else {
                errorEl.textContent = data.message || 'Errore sconosciuto durante il caricamento delle statistiche.';
                errorEl.style.display = 'block';
            }
        } catch (error) {
            console.error('Errore nel fetch delle statistiche:', error);
            errorEl.textContent = 'Impossibile connettersi al server. Riprova più tardi.';
            errorEl.style.display = 'block';
        } finally {
            loadingEl.style.display = 'none';
        }
    }

    // Funzione per renderizzare la tabella
    function renderSpacesTable(spaces) {
        spacesTableBody.innerHTML = ''; // Pulisce la tabella
        if (spaces.length === 0) {
            spacesTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Nessun spazio trovato.</td></tr>`;
            return;
        }

        spaces.forEach(space => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${space.name}</td>
                <td>${space.city}</td>
                <td>${formatSpaceType(space.type)}</td>
                <td>${space.capacity}</td>
                <td>€${typeof space.price_per_day === 'number' ? space.price_per_day.toFixed(2) : parseFloat(space.price_per_day).toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-info me-1" onclick="editSpace('${space._id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSpace('${space.id}')"><i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            spacesTableBody.appendChild(row);
        });
    }

    // Funzione di formattazione del tipo di spazio
    function formatSpaceType(type) {
        const types = {
            'desk': 'Scrivania',
            'meeting_room': 'Sala Meeting',
            'private_office': 'Ufficio Privato',
            'coworking': 'Coworking',
            'hot-desk': 'Hot-Desk',
            'private-desk': 'Scrivania Privata',
            'phone-booth': 'Cabina Telefonica',
            'event-space': 'Spazio Eventi'
        };
        return types[type] || type;
    }

    /**
     * Funzione per applicare i filtri e avviare la ricerca
     * @description Legge i valori dai campi di ricerca e filtra i dati mock degli spazi.
     */
    function applySpaceFilters() {
        // Ottiene i valori dei campi di input e select
        const searchInput = document.getElementById('spaceSearch').value;
        const cityFilter = document.getElementById('cityFilter').value;
        const typeFilter = document.getElementById('spaceTypeFilter').value;

        // Crea un oggetto con i filtri da applicare
        const filters = {};
        if (searchInput) filters.search = searchInput;
        if (cityFilter) filters.city = cityFilter;
        if (typeFilter) filters.type = typeFilter;

        // Resetta la paginazione e ricarica gli spazi con i nuovi filtri
        currentPageSpaces = 1;
        loadSpaces(filters);
    }

    /**
     * Funzione per resettare i filtri di ricerca
     * @description Resetta i valori dei campi di input e ricarica tutti gli spazi.
     */
    function resetSpaceFilters() {
        // Resetta i campi del form
        document.getElementById('spaceSearch').value = '';
        document.getElementById('cityFilter').value = '';
        document.getElementById('spaceTypeFilter').value = '';

        // Resetta la paginazione e ricarica senza filtri
        currentPageSpaces = 1;
        loadSpaces();
    }

    // Funzioni per gestire lo stato di caricamento/errore
    function showLoadingState() {
        spacesTableBody.innerHTML = `<tr><td class="text-center py-4" colspan="7"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Caricamento spazi...</div></td></tr>`;
    }

    function showErrorState(message) {
        spacesTableBody.innerHTML = `<tr><td class="text-center text-danger py-4" colspan="7"><i class="fas fa-exclamation-triangle me-2"></i>${message}</td></tr>`;
    }

    async function saveSpace() {
        const spaceForm = document.getElementById('spaceForm');
        if (!spaceForm.checkValidity()) {
            spaceForm.reportValidity();
            return;
        }

        const amenities = [];
        document.querySelectorAll('#spaceForm .form-check-input[type="checkbox"]').forEach(checkbox => {
            if (checkbox.checked) {
                amenities.push(checkbox.id.replace('Service', ''));
            }
        });

        const spaceData = {
            name: document.getElementById('spaceName').value,
            type: document.getElementById('spaceType').value,
            capacity: parseInt(document.getElementById('spaceCapacity').value),
            price_per_day: parseFloat(document.getElementById('spacePrice').value),
            city: document.getElementById('spaceCity').value,
            address: document.getElementById('spaceAddress').value,
            postal_code: document.getElementById('spacePostalCode').value,
            floor: document.getElementById('spaceFloor').value,
            room: document.getElementById('spaceRoom').value,
            description: document.getElementById('spaceDescription').value,
            notes: document.getElementById('spaceNotes').value,
            open_time: document.getElementById('spaceOpenTime').value,
            close_time: document.getElementById('spaceCloseTime').value,
            days_available: amenities,
            amenities: amenities,
        };

        try {
            const token = localStorage.getItem('auth_token');
            const response = await fetch('http://localhost:3000/api/spaces', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(spaceData),
            });

            const result = await response.json();

            if (response.ok) {
                showNotification('Spazio creato con successo!', 'success');

                // Chiudi il modal solo al successo
                const modalElement = document.getElementById('spaceModal');
                const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                modal.hide();

                loadSpaces();
            } else {
                const errorMessage = result.message || 'Errore nella creazione dello spazio.';
                showNotification(errorMessage, 'error');
            }

        } catch (error) {
            console.error('Errore durante la creazione dello spazio:', error);
            showNotification('Errore di connessione. Riprova più tardi.', 'error');
        }
    }

    async function deleteSpace(spaceId) {
        // Chiedi conferma all'utente
        if (!confirm('Sei sicuro di voler eliminare questo spazio?')) {
            return;
        }

        try {
            const token = localStorage.getItem('auth_token'); // Recupera il token
            const response = await fetch(`http://localhost:3000/api/spaces/${spaceId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}` // Invia il token nell'header
                },
            });

            if (response.ok) {
                showNotification('Spazio eliminato con successo!', 'success');
                loadSpaces(); // Ricarica la tabella per aggiornare la vista
            } else {
                const errorData = await response.json();
                showNotification(errorData.message || 'Errore durante l\'eliminazione dello spazio.', 'error');
            }
        } catch (error) {
            console.error('Errore durante la cancellazione:', error);
            showNotification('Errore di connessione. Riprova più tardi.', 'error');
        }
    }

    async function loadSpacesStats() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.warn('⚠️ Token mancante');
                showErrorState('Accesso negato. Effettua il login.');
                return;
            }

            // Carica statistiche dashboard
            const statsResponse = await fetch('http://localhost:3000/api/spaces/dashboard-stats', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const statsData = await statsResponse.json();
            if (statsData.success) {
                updateSpacesStats(statsData.stats);
            }

            // Carica lista spazi
            const spacesResponse = await fetch('http://localhost:3000/api/spaces/all', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const spacesData = await spacesResponse.json();
            if (spacesData.success) {
                renderSpacesTable(spacesData.spaces);
            } else {
                showErrorState(spacesData.message || 'Errore durante il caricamento degli spazi.');
            }
        } catch (error) {
            console.error('Errore nel caricamento degli spazi:', error);
            showErrorState('Impossibile caricare gli spazi. Riprova più tardi.');
        }
    }

    function updateSpacesStats(stats) {
        // Spazi totali
        const totalSpacesCountEl = document.getElementById('totalSpacesCount');
        if (totalSpacesCountEl) {
            totalSpacesCountEl.textContent = stats.total || 0;
        }

        // Spazi attivi
        const activeSpacesCountEl = document.getElementById('activeSpacesCount');
        if (activeSpacesCountEl) {
            activeSpacesCountEl.textContent = stats.active || 0;
        }

        // Spazi prenotati oggi
        const bookedSpacesCountEl = document.getElementById('bookedSpacesCount');
        if (bookedSpacesCountEl) {
            bookedSpacesCountEl.textContent = stats.bookedToday || 0;
        }

        // Ricavi mensili
        const spacesRevenueEl = document.getElementById('spacesRevenue');
        if (spacesRevenueEl) {
            spacesRevenueEl.textContent = `€${(stats.monthlyRevenue || 0).toLocaleString('it-IT', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }

        // Aggiorna anche i totali della paginazione
        const spacesTotalEl = document.getElementById('spacesTotal');
        if (spacesTotalEl) {
            spacesTotalEl.textContent = stats.total || 0;
        }
    }

    // Carica gli spazi all'avvio della pagina se la sezione spaces è attiva
    document.addEventListener('DOMContentLoaded', () => {
        if (window.location.hash === '#spaces') {
            loadSpaces();
        }
    });
</script>
</body>
</html>