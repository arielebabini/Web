<!-- Bookings Section Template -->
<section id="bookingsSection" class="section-padding">
    <div class="container">
        <div class="bookings-header">
            <h2><i class="fas fa-calendar-check text-primary"></i> Le Mie Prenotazioni</h2>
            <p class="text-muted">Gestisci e monitora le tue prenotazioni</p>
        </div>

        <!-- Booking Filters -->
        <div class="booking-filters">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" data-filter="all">
                            Tutte
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-filter="upcoming">
                            Prossime
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-filter="past">
                            Passate
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-filter="cancelled">
                            Cancellate
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <select class="form-select d-inline-block w-auto" id="sortBookings">
                        <option value="date-desc">Data: Più Recente</option>
                        <option value="date-asc">Data: Meno Recente</option>
                        <option value="price-high">Prezzo: Alto → Basso</option>
                        <option value="price-low">Prezzo: Basso → Alto</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Bookings Container -->
        <div id="bookingsContainer" class="bookings-grid">
            <!-- Bookings will be loaded here by JavaScript -->
        </div>

        <!-- Empty State (initially hidden) -->
        <div id="bookingsEmptyState" class="text-center py-5" style="display: none;">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <h4>Nessuna prenotazione trovata</h4>
            <p class="text-muted">Non hai ancora effettuato nessuna prenotazione</p>
            <button class="btn btn-primary" onclick="App.navigation?.showSection?.('spaces')">
                <i class="fas fa-search"></i> Esplora Spazi
            </button>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions mt-5">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-plus-circle fa-2x text-primary mb-3"></i>
                            <h6>Nuova Prenotazione</h6>
                            <p class="text-muted small">Trova e prenota il tuo prossimo spazio</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="App.navigation?.showSection?.('spaces')">
                                Prenota Ora
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-history fa-2x text-primary mb-3"></i>
                            <h6>Cronologia</h6>
                            <p class="text-muted small">Visualizza tutte le prenotazioni passate</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="showBookingHistory()">
                                Vedi Tutto
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-file-invoice fa-2x text-primary mb-3"></i>
                            <h6>Fatture</h6>
                            <p class="text-muted small">Scarica le fatture delle tue prenotazioni</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="showInvoices()">
                                Gestisci
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Booking Detail Modal -->
<div class="modal fade" id="bookingDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingDetailTitle">Dettagli Prenotazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookingDetailBody">
                <!-- Content loaded by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-outline-danger" id="cancelBookingBtn" style="display: none;">
                    <i class="fas fa-times"></i> Cancella Prenotazione
                </button>
                <button type="button" class="btn btn-primary" id="modifyBookingBtn" style="display: none;">
                    <i class="fas fa-edit"></i> Modifica
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Bookings management functions
    const BookingsManager = {
        currentFilter: 'all',
        currentSort: 'date-desc',

        init() {
            this.setupEventListeners();
            this.loadBookings();
        },

        setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    this.setActiveFilter(e.target);
                    this.currentFilter = e.target.getAttribute('data-filter');
                    this.filterBookings();
                });
            });

            // Sort dropdown
            const sortSelect = document.getElementById('sortBookings');
            if (sortSelect) {
                sortSelect.addEventListener('change', (e) => {
                    this.currentSort = e.target.value;
                    this.sortBookings();
                });
            }
        },

        setActiveFilter(activeBtn) {
            document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.remove('active'));
            activeBtn.classList.add('active');
        },

        loadBookings() {
            // Mock bookings data
            const mockBookings = [
                {
                    id: 1,
                    spaceId: 1,
                    spaceName: "Milano Business Hub",
                    spaceImage: "https://images.unsplash.com/photo-1497366216548-37526070297c?w=300",
                    date: "2024-03-15",
                    startTime: "09:00",
                    endTime: "17:00",
                    people: 4,
                    totalPrice: 85,
                    status: "confirmed",
                    bookingCode: "CW2024001",
                    notes: "Riunione importante con clienti"
                },
                {
                    id: 2,
                    spaceId: 2,
                    spaceName: "Milano Creative Space",
                    spaceImage: "https://images.unsplash.com/photo-1556761175-b413da4baf72?w=300",
                    date: "2024-03-10",
                    startTime: "14:00",
                    endTime: "18:00",
                    people: 2,
                    totalPrice: 45,
                    status: "completed",
                    bookingCode: "CW2024002",
                    notes: ""
                }
            ];

            // Check if user is logged in
            if (!App.auth.isAuthenticated()) {
                this.showEmptyState();
                return;
            }

            this.renderBookings(mockBookings);
        },

        renderBookings(bookings) {
            const container = document.getElementById('bookingsContainer');
            const emptyState = document.getElementById('bookingsEmptyState');

            if (bookings.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.style.display = 'block';

            container.innerHTML = bookings.map(booking => this.createBookingCard(booking)).join('');
            this.setupBookingCardEvents();
        },

        createBookingCard(booking) {
            const statusClass = this.getStatusClass(booking.status);
            const statusLabel = this.getStatusLabel(booking.status);
            const isUpcoming = new Date(booking.date) > new Date();

            return `
            <div class="col-md-6 mb-4">
                <div class="card booking-card" data-booking-id="${booking.id}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">${booking.spaceName}</h6>
                        <span class="badge ${statusClass}">${statusLabel}</span>
                    </div>
                    <div class="row g-0">
                        <div class="col-4">
                            <img src="${booking.spaceImage}" class="img-fluid h-100" style="object-fit: cover;" alt="${booking.spaceName}">
                        </div>
                        <div class="col-8">
                            <div class="card-body">
                                <div class="booking-info">
                                    <p class="mb-2">
                                        <i class="fas fa-calendar text-primary"></i>
                                        <strong>Data:</strong> ${this.formatDate(booking.date)}
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-clock text-primary"></i>
                                        <strong>Orario:</strong> ${booking.startTime} - ${booking.endTime}
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-users text-primary"></i>
                                        <strong>Persone:</strong> ${booking.people}
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-euro-sign text-primary"></i>
                                        <strong>Totale:</strong> €${booking.totalPrice}
                                    </p>
                                    <p class="mb-0 small text-muted">
                                        <i class="fas fa-hashtag"></i> ${booking.bookingCode}
                                    </p>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary btn-sm me-2" onclick="BookingsManager.showBookingDetail(${booking.id})">
                                        <i class="fas fa-eye"></i> Dettagli
                                    </button>
                                    ${isUpcoming ? `
                                        <button class="btn btn-outline-warning btn-sm" onclick="BookingsManager.modifyBooking(${booking.id})">
                                            <i class="fas fa-edit"></i> Modifica
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        },

        getStatusClass(status) {
            const classes = {
                'confirmed': 'bg-success',
                'completed': 'bg-primary',
                'cancelled': 'bg-danger',
                'pending': 'bg-warning'
            };
            return classes[status] || 'bg-secondary';
        },

        getStatusLabel(status) {
            const labels = {
                'confirmed': 'Confermata',
                'completed': 'Completata',
                'cancelled': 'Cancellata',
                'pending': 'In Attesa'
            };
            return labels[status] || 'Sconosciuto';
        },

        formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        },

        setupBookingCardEvents() {
            // Click on card to show details
            document.querySelectorAll('.booking-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        const bookingId = parseInt(card.getAttribute('data-booking-id'));
                        this.showBookingDetail(bookingId);
                    }
                });
            });
        },

        showBookingDetail(bookingId) {
            // Mock booking detail
            const booking = {
                id: bookingId,
                spaceName: "Milano Business Hub",
                spaceAddress: "Via Brera 12, Milano",
                date: "2024-03-15",
                startTime: "09:00",
                endTime: "17:00",
                people: 4,
                totalPrice: 85,
                status: "confirmed",
                bookingCode: "CW2024001",
                notes: "Riunione importante con clienti",
                amenities: ["WiFi", "Caffè", "Stampante", "Parcheggio"]
            };

            const modalTitle = document.getElementById('bookingDetailTitle');
            const modalBody = document.getElementById('bookingDetailBody');

            modalTitle.textContent = `Prenotazione #${booking.bookingCode}`;
            modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Dettagli Spazio</h6>
                    <p><strong>${booking.spaceName}</strong></p>
                    <p class="text-muted">${booking.spaceAddress}</p>

                    <h6 class="mt-4">Dettagli Prenotazione</h6>
                    <ul class="list-unstyled">
                        <li><strong>Data:</strong> ${this.formatDate(booking.date)}</li>
                        <li><strong>Orario:</strong> ${booking.startTime} - ${booking.endTime}</li>
                        <li><strong>Persone:</strong> ${booking.people}</li>
                        <li><strong>Stato:</strong> <span class="badge ${this.getStatusClass(booking.status)}">${this.getStatusLabel(booking.status)}</span></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Riepilogo Pagamento</h6>
                    <div class="bg-light p-3 rounded">
                        <div class="d-flex justify-content-between">
                            <span>Subtotale:</span>
                            <span>€${booking.totalPrice}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Commissioni:</span>
                            <span>€0</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Totale:</span>
                            <span>€${booking.totalPrice}</span>
                        </div>
                    </div>

                    <h6 class="mt-4">Servizi Inclusi</h6>
                    <div class="d-flex flex-wrap gap-1">
                        ${booking.amenities.map(amenity => `
                            <span class="badge bg-light text-dark">${amenity}</span>
                        `).join('')}
                    </div>

                    ${booking.notes ? `
                        <h6 class="mt-4">Note</h6>
                        <p class="text-muted">${booking.notes}</p>
                    ` : ''}
                </div>
            </div>
        `;

            // Show action buttons based on status
            const cancelBtn = document.getElementById('cancelBookingBtn');
            const modifyBtn = document.getElementById('modifyBookingBtn');

            if (booking.status === 'confirmed' && new Date(booking.date) > new Date()) {
                cancelBtn.style.display = 'inline-block';
                modifyBtn.style.display = 'inline-block';
            } else {
                cancelBtn.style.display = 'none';
                modifyBtn.style.display = 'none';
            }

            const modal = new bootstrap.Modal(document.getElementById('bookingDetailModal'));
            modal.show();
        },

        modifyBooking(bookingId) {
            App.utils?.showNotification?.('Modifica prenotazione disponibile nella versione completa', 'info');
        },

        cancelBooking(bookingId) {
            if (confirm('Sei sicuro di voler cancellare questa prenotazione?')) {
                App.utils?.showNotification?.('Prenotazione cancellata con successo', 'success');
                // Here you would actually cancel the booking
                const modal = bootstrap.Modal.getInstance(document.getElementById('bookingDetailModal'));
                modal.hide();
            }
        },

        filterBookings() {
            // Implementation for filtering bookings
            App.utils?.showNotification?.(`Filtro "${this.currentFilter}" applicato`, 'info');
        },

        sortBookings() {
            // Implementation for sorting bookings
            App.utils?.showNotification?.(`Ordinamento "${this.currentSort}" applicato`, 'info');
        },

        showEmptyState() {
            document.getElementById('bookingsContainer').style.display = 'none';
            document.getElementById('bookingsEmptyState').style.display = 'block';
        }
    };

    // Global functions for support section
    function showBookingHistory() {
        App.utils?.showNotification?.('Cronologia completa disponibile nella versione completa', 'info');
    }

    function showInvoices() {
        App.utils?.showNotification?.('Gestione fatture disponibile nella versione completa', 'info');
    }

    // Initialize when document is ready
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('bookingsSection')) {
            BookingsManager.init();
        }
    });
</script>